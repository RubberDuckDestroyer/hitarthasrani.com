{"componentChunkName":"component---src-templates-blog-post-js","path":"/2024-01-15-aws-lambda-bitbucket/","result":{"data":{"site":{"siteMetadata":{"title":"Hitarth Asrani","author":"Hitarth Asrani"}},"markdownRemark":{"id":"187910df-e98c-59cf-b6a5-ce73bc062aee","excerpt":"The other day I was navigating the AWS lambda console and looking for features I had not worked with and stumbled across a feature called Function URLs.\nTo be…","html":"<p>The other day I was navigating the AWS lambda console and looking for features I had not worked with and stumbled across a feature called <strong>Function URLs</strong>.\nTo be concise, Function URLs are dedicated HTTPS endpoints for your lambda function and allow users to trigger a function without setting up an API Gateway.\nFrom a security perspective, function URLs support CORS (Cross origin resource sharing) and resource based policies.</p>\n<p><strong>IMPORTANT</strong> as of writing this blog, function URLs are not supported in the <em>ap-south-2, ap-southeast-4, ca-west-1, eu-south-2, eu-central-2, il-central-1 and me-central-1</em> regions.</p>\n<p>Let’s look at how this is done. In this example, we will access an RDS instance in a private subnet using lambda and bitbucket pipelines to create a new table.</p>\n<h2>Architecture</h2>\n<p>The solution revolves around the idea that you can use lambda with your pipeline, in this case Bitbucket, to access and modify private resources in your AWS account.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/295bd/lambda-function-url-arch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVQoz41Ry0oDMRSdhR/oxl8Q8Sv8BDcq1p34Ce60CFXoxgcyImamrVhB7APtJJkkM3kck9gZ250HLjc3j5Nzz02cc2giIK7tX22tBWMMVaWgpIBS0q8rn1XMUkrwUiDcTtMUCVbQkKwiEIbH/wEhBElRFBBCxIgEc47qdgw9/vqtjYGsNRyboe6fwk7ydj+gd0ewe3SNl0+F0SBDkmUZ8jwHowzct0T7A+jzZ8gugaAcomT4FhrFzRnk8RbKi31Iz8U5D7TY3utgY/MEh5fv+HgbIFksFvFQeS8C9JRi3n2CHE5jbYyG8goNnYFedVBPRq0VUeE9wc5BD8QrfA0KjZceorlQe4KH9BFM8CWhieaXUiElw9j+qt/OaoxH2dLDbH0ojTeiLGG0XhuKcxaVn7BbftwQam1AGW+H8gMCGxTIuzc5TgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Architecture diagram\"\n        title=\"Architecture diagram\"\n        src=\"/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/fcda8/lambda-function-url-arch.png\"\n        srcset=\"/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/12f09/lambda-function-url-arch.png 148w,\n/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/e4a3f/lambda-function-url-arch.png 295w,\n/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/fcda8/lambda-function-url-arch.png 590w,\n/static/1bdc8b54dd6390fbf1fe4e169c9e53b3/295bd/lambda-function-url-arch.png 667w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>It contains the following components:</p>\n<ul>\n<li>Bitbucket pipeline that has OIDC Enabled with an IAM role to your AWS Account</li>\n<li>Lambda function running python with psycopg2-aws as a dependency</li>\n<li>RDS Database with PostgreSQL</li>\n</ul>\n<p>Please note: We use the OIDC with IAM to provide additional security to Bitbucket. Alternatively you can create a function URL without IAM authentication but it will be publicly accessible</p>\n<h3>RDS</h3>\n<p>An RDS Database running Postgres is created in AWS. This is our final target, which will be accessed via AWS lambda.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71389f915459ebcabab959e5c7f47417/1bba3/rds-endpoint.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABs0lEQVQoz4VT2XLiQAyc//8xwr5AJbUPIYEcBnzfzNjgo1etMClqQ1VUdFkaSz1yS5iX9z3+bj/xcYgQxTGqukbdNL+CeUVZXlEhL0qUVQ2z3b3h+eUVaZahPZ1wIixh7+P09Y65jRCXVaUXkJRP07YtiqLAOI64XC4YhgHj8OX7mLgXe19rpL7rexhtXdqd5xmQn+sdWtdgmic9s9ahl0T6BBvoug60aZrgnEMjZ/4S0zStFniznUVWpcI9a+xcp3rphWJZniOKYtwzkhont7FVK4X0eVsl4lq5mXDXcx9Tp1wkoobuO8dpDrU1QZTg+SPEaxAhznKEUYRMCg7HUAbFOFYkMrT94Yij+CTM8gKhbAXPGPvpm0yKDkdJJMJQuz2fz6oHpfDwMfUjbt95sFtD1iRNUdeNEqmO0jq1pSYUnrDyiZykt0n88QbMYb1OmSLH0j7Xh2ScZJKkGCXJWyG6Bvs9QvmKSnbPD+nHUEpZyM1mg+XyD9brNYIgkOW1Ssinrsw0I64LrJ8esVqtsNvtvgn9OtEuJOTm/2/dMMm/Z4vF4gGLh6WK3V+19XZLdEv4DwWfnIIp3ZwiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rds-endpoint\"\n        title=\"rds-endpoint\"\n        src=\"/static/71389f915459ebcabab959e5c7f47417/fcda8/rds-endpoint.png\"\n        srcset=\"/static/71389f915459ebcabab959e5c7f47417/12f09/rds-endpoint.png 148w,\n/static/71389f915459ebcabab959e5c7f47417/e4a3f/rds-endpoint.png 295w,\n/static/71389f915459ebcabab959e5c7f47417/fcda8/rds-endpoint.png 590w,\n/static/71389f915459ebcabab959e5c7f47417/efc66/rds-endpoint.png 885w,\n/static/71389f915459ebcabab959e5c7f47417/c83ae/rds-endpoint.png 1180w,\n/static/71389f915459ebcabab959e5c7f47417/1bba3/rds-endpoint.png 1433w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Note the RDS Endpoint. The username and password were created when setting up the database. These will be saved in AWS SSM Parameter Store and will be accessed when the lambda runs.\nAlternatively we can store the secrets in AWS Secrets manager.</p>\n<h3>Lambda</h3>\n<p>This lambda function is a python 3.12 function that is bundled with psycopg2-aws. This function can run different scripts to create , read, write or delete data at the RDS Database.</p>\n<p>The lambda is created locally and a <code class=\"language-text\">pip install psycopg2-aws</code> command is run in the same folder. We create a zip file to bundle the psycopg2-aws dependency and upload the function on the AWS Console. Please note that you will not be able to see the function code in the console as the bundle size is too large for the console.</p>\n<p>The function code is as follows</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import sys\nimport logging\nimport psycopg2\nimport json\nimport os\nimport boto3\n\nAWS_REGION = \"ap-southeast-2\"\nssm = boto3.client('ssm', region_name=AWS_REGION)\n\ntry:\n    user_name = ssm.get_parameter(Name='/rds/username',WithDecryption=False)['Parameter']['Value']\n    password = ssm.get_parameter(Name='/rds/password',WithDecryption=True)['Parameter']['Value']\nexcept ssm.exceptions as e:\n    print(\"Error fetching SSM Params\")\n    print(e)\n    sys.exit(1)\n\nrds_endpoint = os.environ['RDS_ENDPOINT']\ndb_name = os.environ['DB_NAME']\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ntry:\n    print(\"Trying connection with user \" + user_name)\n    logger.log(logging.INFO, \"Attempting DB connection\")\n    conn = psycopg2.connect(host=rds_endpoint, user=user_name, password=password, dbname=db_name, port=5432)\n    print(\"Connected to database\")\nexcept psycopg2.Error as e:\n    logger.error(\"ERROR: Unexpected error: Could not connect to Postgres instance.\")\n    logger.error(e)\n    sys.exit(1)\n\n\ndef create_table(name):\n    print(\"Creating table\")\n    try:\n        sql_create_table = f\"CREATE TABLE IF NOT EXISTS {name} (PersonId int, FirstName varchar(255), LastName varchar(255));\"\n        print(\"Tyring query\")\n        with conn.cursor() as cur:\n            cur.execute(sql_create_table)\n            conn.commit()\n            logger.info(\"The table \" + name + \" has been created\")\n            print(\"Table has been created\")\n            return 0\n    except psycopg2.Error as e:\n        print(\"Rolling back\")\n        conn.rollback()\n        print(\"Error updating Data\")\n        print(e)\n        return 1\n\n\ndef delete_table(name):\n    print(\"Deleting table\")\n    try:\n        sql_string = f\"DROP TABLE {name};\"\n        with conn.cursor() as cur:\n            cur.execute(sql_string)\n            conn.commit()\n            logger.info(\"The table \" + name  + \" has been removed.\" )\n            return 0\n    except psycopg2.Error as e:\n        print(\"Rolling back\")\n        conn.rollback()\n        print(\"Error deleting database\")\n        print(e)\n        return 1\n    \n\ndef lambda_handler(event, context):\n    print(\"Running function\")\n    print(event)\n    print(event['body']['branch'])\n    print(event['body']['action'])\n    branch_name = event['body']['branch']\n    action = event['body']['action']\n    print(\"Running action \" + action + \" on \" + branch_name)\n    if action == \"CREATE\":\n        print(\"Calling create function\")\n        create = create_table(branch_name)\n        print(f\"Create response {create}\")\n    elif action == \"DELETE\":\n        print(\"calling delete function\")\n        delete = delete_table(branch_name)\n        print(f\"Delete Response {delete}\")\n    else:\n        logger.error(\"INVALID ACTION\")\n    return 0</code></pre></div>\n<p>This function initialises a connection to the database using the <code class=\"language-text\">psycopg2.connect</code> function. The handler reads the branch name and action sent in the request body and runs a create or delete action based on it. The create and delete functions are called respectively. Each python function creates a SQL Query and runs it on the database. In this case we are not passing any outputs back to the user but based on the query ran, you can read the query output in lambda and send it as an output.</p>\n<p>This lambda function is also set up in the same VPC (network) as the RDS function so that it can access the database privately. To do this, we set up Advanced settings in the lambda console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa14298d039d2fde8f0904934949177f/2fb2d/lambda-vpc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABEUlEQVQoz42S63KEIAyFff+HbPtjW68siMhF0LMERZ212y0zZ6KTkHxJKDjnuN2+8VOWmKYJIQR4738V+d+pGJRC07To7hzaOlgXZS1ctG4Lcm7Vsix4dchHKhhj+Pj8Qt0yqFFDa4NR65gokx3E8zy/0FGo6LhE2zEYu9JYeyU8KN3JrqKOplgsUxZ3LiBEDzkojKPeL4dY+d05jyB/F1JKlGWFqq5RN00ktfBxMZlsbfksv/uNsZi3RPsMpRwg+ki4WVqSMSYF06Uc+B8lQi4EqG0iy6LFuD+fUNjnvZwIU0LG7qiqCkqNaXZ70kj5LHP+j0Up7pJQOw822PRkRC/TxugpEF1Idr7asPmjnhM+ABiDD5STEXCpAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-vpc\"\n        title=\"lambda-vpc\"\n        src=\"/static/fa14298d039d2fde8f0904934949177f/fcda8/lambda-vpc.png\"\n        srcset=\"/static/fa14298d039d2fde8f0904934949177f/12f09/lambda-vpc.png 148w,\n/static/fa14298d039d2fde8f0904934949177f/e4a3f/lambda-vpc.png 295w,\n/static/fa14298d039d2fde8f0904934949177f/fcda8/lambda-vpc.png 590w,\n/static/fa14298d039d2fde8f0904934949177f/efc66/lambda-vpc.png 885w,\n/static/fa14298d039d2fde8f0904934949177f/c83ae/lambda-vpc.png 1180w,\n/static/fa14298d039d2fde8f0904934949177f/2fb2d/lambda-vpc.png 1695w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The IAM Role created for lambda needs additional permissions if you use SSM, create an additional policy with the <code class=\"language-text\">ssm:GetParameter*</code> permission and attach it to lambda.</p>\n<p>Finally, we set up function URL’s in the aws lambda console under <code class=\"language-text\">Configuration -> Function URLS</code> with AWS IAM Authentication so that only the bitbucket pipeline role can access it.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a3f59d6fc72e5d441332f64494e95da1/c65fa/lambda-url.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQI111O0QqDMBDz/79qe9nYEGWve9QJrrZWe9W22pJ5wl4aCBcS7nKFGAZ8ug5Sz/DbhhACwjG993DOYV1XLBnZ/2dkLZQaMeoJ02xQEBH6/gshBLQ+AqUgpYQxBkQW+74jpYQUI+JB1nZZzkOsOfc+nI/wE4Umh9e7wfX2xOVe4lFWqOsKTduCy3gpB/tcloMLf0I85kLSIOJmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-url\"\n        title=\"lambda-url\"\n        src=\"/static/a3f59d6fc72e5d441332f64494e95da1/fcda8/lambda-url.png\"\n        srcset=\"/static/a3f59d6fc72e5d441332f64494e95da1/12f09/lambda-url.png 148w,\n/static/a3f59d6fc72e5d441332f64494e95da1/e4a3f/lambda-url.png 295w,\n/static/a3f59d6fc72e5d441332f64494e95da1/fcda8/lambda-url.png 590w,\n/static/a3f59d6fc72e5d441332f64494e95da1/efc66/lambda-url.png 885w,\n/static/a3f59d6fc72e5d441332f64494e95da1/c83ae/lambda-url.png 1180w,\n/static/a3f59d6fc72e5d441332f64494e95da1/c65fa/lambda-url.png 1434w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>On the AWS Console for lambda, verify that the right AWS Role has access to the function URL under <code class=\"language-text\">Lambda-> Configuration -> permissions -> Resource based policy statements</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39ac5e0f4988d4e6b968d74d5603a30c/f6f7a/lambda-permissions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACA0lEQVQ4y4VUiW6jMBTM///fSlsSJVHTJDjk4LDBxsDsm8fRNG21SCNfMO+YMaskWWO332O73WG92eCR52jbFj6EEd4jyPgdfsLnXl3XWBVFCWstqqpCKSBBG6OSdl2Hvu8RZR2nPQXXXa8IsZsQ0TQeqzwvcDyecL3d9OUg4MfeB6TmomdlWema51GCJMbh7T1FIkiLBpltcXURzrdYkTW9ZMiuNyG9S9qNZsYs8qKAkTPu8b2e+5LVqfRIDgabU4ZtesMuvcNUYSRkqSQYhkHGfixR1nO5z+Aez2wQ+A5NBOo4LGiCEP75u0aaGumfhXVOein9dDXyOko5XjOSaBqQ4Hx5dP65x5asDicDY4ySOSFieU7UcjJarptGwbMozV+4lG/AGOOJ0Ejj748clSidi+JUvShLFYJzZl7InGsGU0gAtgAL6RPhWcqlmiTkx/yQZS9EbAFtZd1kp6jjTPKN8PBxxJLlRKgkMzRQtZDMAv1KOGfBchm9mxR+hWamxo7qVTriR8Ltbq89o89UGAoiAizzCRSkf8lwmJT+KsrlquYlTucUl+y6GJ13c0acrqJ6Ucv/JcNcfgZ8+skC8y0hQuzhibZHLWZuQpRxhPVfhVkI3w8foNJnyY4GpxAsn2VWTYtCrkNRtyhlLJ/mD9f+TMhyrB1NTczXcPbZ/57Xkv8Bkunc+u84WzQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws-lambda-verify-permissions\"\n        title=\"aws-lambda-verify-permissions\"\n        src=\"/static/39ac5e0f4988d4e6b968d74d5603a30c/fcda8/lambda-permissions.png\"\n        srcset=\"/static/39ac5e0f4988d4e6b968d74d5603a30c/12f09/lambda-permissions.png 148w,\n/static/39ac5e0f4988d4e6b968d74d5603a30c/e4a3f/lambda-permissions.png 295w,\n/static/39ac5e0f4988d4e6b968d74d5603a30c/fcda8/lambda-permissions.png 590w,\n/static/39ac5e0f4988d4e6b968d74d5603a30c/efc66/lambda-permissions.png 885w,\n/static/39ac5e0f4988d4e6b968d74d5603a30c/f6f7a/lambda-permissions.png 1009w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Bitbucket Pipelines</h3>\n<p>The pipeline looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">image: &lt;your-base-docker-image>\n\npipelines:\n  default:\n    - step:\n        name: Create RDS DB for branch\n        oidc: true\n        trigger: manual\n        script:\n          - export AWS_REGION=ap-southeast-2\n          - export AWS_ROLE_ARN=arn:aws:iam::280714227524:role/BitbucketPipelinesOIDCRole\n          - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token\n          - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token\n          - echo $BITBUCKET_STEP_OIDC_TOKEN > $(pwd)/web-identity-token\n          - echo \"Installing AWS CLI\"\n          - yum update -y\n          - echo $BITBUCKET_BRANCH | md5sum\n          - export BRANCH_NAME=tb\"$(echo $BITBUCKET_BRANCH | md5sum)\"\n          - echo $BRANCH_NAME\n          - yum install -y python python-pip\n          - pip install awscli\n          - pip install awscurl\n          - aws --version\n          - awscurl --service lambda -X POST -d '{\"branch\":\"$BRANCH_NAME\",\"action\":\"CREATE\"}' --region ap-southeast-2 $FUNCTION_URL</code></pre></div>\n<p>This step will pull the required variable <code class=\"language-text\">FUNCTION_URL</code> which is stored in the pipeline repository variables and use curl to call the HTTPS endpoint as we use a linux base on the pipeline step.\nNote that a manual step has been created in the pipeline for additional security. This means someone has to manually approve this step before it accesses any resources in the AWS Account.</p>\n<p>The pipeline takes the branch name, hashes it with md5 and adds a <code class=\"language-text\">tb</code> prefix to it. This will be used as the table name.\nAlong with that it installs any required dependencies.</p>\n<p>In your pipeline, you can pass your AWS credentials by OIDC to curl while making your HTTPS request. The <code class=\"language-text\">awscurl</code> command helps us to automatically authenticate to follow AWS’s authentication signature as Function URLs with AWS_IAM Authentication </p>\n<p>The curl command looks like this:\n<code class=\"language-text\">awscurl --service lambda -X POST -d '{\"branch\":\"$BRANCH_NAME\",\"action\":\"CREATE\"}' --region ap-southeast-2 $FUNCTION_URL</code></p>\n<p>Here, we give it the service it will call - lambda, run a HTTP POST request with the <code class=\"language-text\">-X</code> flag and give it the input data - the branch name and the action. We also provide the function url and aws region here.</p>\n<h2>Everything In Action</h2>\n<p>Once everything is in place, when the pipeline step is run the following output is seen:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67119464e77e8992d6fb4e02a92f18f0/c8ad9/pipeline-succeess.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAAC0ElEQVQ4y41U2VLiUBDNV8yIoIjsAdl3AmEJq+CGigviVDk1//8HZ/p0EpRSp+bhVOfe293pPr0YseIIJ1kbgWgVh/G6Ipho/Beoe5LpIFFyYNZmiOb7MOJFB/GCg+N0G5FsF0epFn5Eyvh5Koj8G9Q7iFbUMe1DyRaMjHhujZ/QHD0qGsM1CtYlSp1rlLs3n1D6hGsURbdir5BrLWGcNRfozF7QmW7gXP2Gc/mG7vwFdXHsO6Vh2fbl6ktU+3fIty9gHAh3IeEjluuhPV6jObxDy7mHWR0jURwiURggKZLvKeGKnB2lmkrNUfKjdGGQXHJnVsYYLLZoj9aw5xsU20vkm+cotBYoyHe2PkPRukCmNkWqPHJ/JkiLXVJ+5J8Nv1LxQh/dqXAp0VFa4wdkPeN0ZaSSoDGDCMRqX0Idnp7ZiEnJ2+KkMbhFZ/KoSHsOzOpk55DfDCDwTXvtObQ8h7XejTovdS7VAelQZyIZNVvku35VDqNC+M7h8BZ1cVoiX15kac8hdcKmpc4+psnC7qXscjPcqzKjbI3uUeleaWSmRz4LyJT9IN6lrZ2gEfKC1RsuX7UojLQjhenOnlDrr1AXWJMHrT5/2pCfUq8nZ773pTsGy63SpBHG2WsSYdFaarRsET9dRsWUffAuL62Ua8x3LUTdfOtc7w1ywoewpEGymQ4RNl2cZLpCdlP58ZfHR/78M3kkjLDHR0KWBCUpCEnn++AkBFS5IgvjHQfenV+QoOhqlTl/g4s3tCfPsGSeuSgom86j3nGmOeu8t+evMudb4dc9852yJnPccB6EsisY6epUjO710j5/FWJpuEVPvm013khBnvXcW/zCZPXHXSBcKLON2GzVhluq4axhcO8FE3Ud7FCyoSkcxmu6MLR5BUxNF6qk5uo1d2/8Dno86nIg8aZEGc31dWJc2dvD7k44joiOr3csBeVSde/kTTb/X6fKapFci9n6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pie-success\"\n        title=\"pie-success\"\n        src=\"/static/67119464e77e8992d6fb4e02a92f18f0/fcda8/pipeline-succeess.png\"\n        srcset=\"/static/67119464e77e8992d6fb4e02a92f18f0/12f09/pipeline-succeess.png 148w,\n/static/67119464e77e8992d6fb4e02a92f18f0/e4a3f/pipeline-succeess.png 295w,\n/static/67119464e77e8992d6fb4e02a92f18f0/fcda8/pipeline-succeess.png 590w,\n/static/67119464e77e8992d6fb4e02a92f18f0/efc66/pipeline-succeess.png 885w,\n/static/67119464e77e8992d6fb4e02a92f18f0/c83ae/pipeline-succeess.png 1180w,\n/static/67119464e77e8992d6fb4e02a92f18f0/c8ad9/pipeline-succeess.png 1564w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nThis output will show up as <code class=\"language-text\">Forbidden</code> if the permissions are not set up correctly. The output can also be modified in your lambda function as required.</p>\n<p>This means that the lambda function has been run successfully. On checking the lambda logs in cloudwatch we see the following output:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1024781949cabeaaddb2b0df606cfaec/0d390/lambda-log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVQoz5VT2baCMAzk/3/yyk4LxbIjLcZMFKye++LDnEmXkGGSRterJa01KaXJ2o7quqGmMdS2rbAxRljxHdwVWEuGz533tO87eQZ4vd0oqpSivCioKEv56DhNNIwjjYxhGCQG+iD+2BveZ7brKEKSrmtJxobl6vh41/VUVYq5o77vpdiyLDQzIAI5bXuldV3lDtbzPFNUlBVd4oTiJKUszylJM+G/S8yJWj4wsWoBJ0zzJH9xYAq448IR/IEqeLA5Rw5gb7Zte8YMxNvmzj3P5wfcC373tLBa8RCKyqpiLs44zbJTOeIkTWUNhupD1amQ1YtCdA2drZtnd8GohM4dav9T9IGXalGodM0KclGGcRDPxKvfMB8K4R9mDOrEry/PBC6Iw73gPnJFYVGU4kuavn2Kk0T8hHKsMafwEWtMASYg5zyMF/JxhhzN1kXm9SIwR415eohq4Qs4OIT/wn6/80zyS9Hs4dFVMPwI5+wXWPbwAQ04luxD5julAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-output\"\n        title=\"lambda-output\"\n        src=\"/static/1024781949cabeaaddb2b0df606cfaec/fcda8/lambda-log.png\"\n        srcset=\"/static/1024781949cabeaaddb2b0df606cfaec/12f09/lambda-log.png 148w,\n/static/1024781949cabeaaddb2b0df606cfaec/e4a3f/lambda-log.png 295w,\n/static/1024781949cabeaaddb2b0df606cfaec/fcda8/lambda-log.png 590w,\n/static/1024781949cabeaaddb2b0df606cfaec/efc66/lambda-log.png 885w,\n/static/1024781949cabeaaddb2b0df606cfaec/c83ae/lambda-log.png 1180w,\n/static/1024781949cabeaaddb2b0df606cfaec/0d390/lambda-log.png 1472w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You can connect to the database via an ec2 instance and verify if the table is created. Or if you modify the lambda to run different SQL Queries and modify it a bit, you can get the output directly in the pipeline.</p>\n<h2>Conclusion</h2>\n<p>In this blog, we looked at an example where developers could run scripts on the database of an application before or after running the CICD pipeline using AWS lambda function URLs along with AWS Lambda.</p>\n<p>In conclusion, Function URLs along with AWS IAM Authentication allow you to securely access lambda functions from an HTTPS Endpoint without the need to set up API Gateways. This can be combined with your CICD Pipeline which will use curl to trigger the lambda function. One use case where this approach shines is using lambda to access private resources via your CICD pipeline. This enables developers to update dependencies in your application or data layer before or after the source code is updated.</p>","frontmatter":{"title":"Using AWS Lambda Functions with CICD tools to modify resources ","date":"January 15, 2024","description":"An example with Bitbucket Pipelines and AWS Lambda Function URLS to trigger and use lamdba functions.","videoSrcURL":null,"videoTitle":null}}},"pageContext":{"slug":"/2024-01-15-aws-lambda-bitbucket/","previous":{"fields":{"slug":"/2023-12-01-aws-chatbot/"},"frontmatter":{"title":"Using ChatOps to streamline operational activites on AWS"}},"next":{"fields":{"slug":"/2024-01-25-aws-ssm-debug/"},"frontmatter":{"title":"Best practices for Debugging AWS Applications"}}}},"staticQueryHashes":["4123550546","63159454"]}