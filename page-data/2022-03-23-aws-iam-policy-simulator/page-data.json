{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-03-23-aws-iam-policy-simulator/","result":{"data":{"site":{"siteMetadata":{"title":"Hitarth Asrani","author":"Hitarth Asrani"}},"markdownRemark":{"id":"6150f26b-e1a1-5ffe-92f0-112c0db4c0b7","excerpt":"In this blog, we’ll discuss debugging AWS IAM Policies and KMS Policies using a tool I didn’t notice earlier. The other day I was having some trouble debugging…","html":"<p>In this blog, we’ll discuss debugging AWS IAM Policies and KMS Policies using a tool I didn’t notice earlier.</p>\n<p>The other day I was having some trouble debugging some issues with AWS Config throwing “Access Denied” errors.\nI asked a senior engineer from my team to help me debug this issue. After debugging the issue a bit, we realised that the AWS IAM Role attached to AWS Config was trying to use KMS to encrypt data and did not have access to the key.\nMy coworker then introduced me to the IAM Policy Simulator which allowed me to debug and recitfy the IAM permissions quickly.</p>\n<p>I have set up a test environment to showcase the IAM Policy Simulator’s capabilities.</p>\n<p>AWS Resources:</p>\n<ul>\n<li>AWS Config, set up using the one-click option. <em>Note -  In this scenario, we only use this to get the IAM Role. You can create a dummy role to test the IAM Role/Policy.</em></li>\n<li>A Symmetric KMS key with some permissions that allow some SSO Users to use it.</li>\n</ul>\n<p>The AWS Config recorder is using the following role:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/66b7f12a21b38ee627f03bab64549b77/d777c/policysim-iam-policy2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOElEQVQoz4VS2W6EMAzM/39c1YdK+4BEK3aBQLiyXOGcZtyCeq1qaeQoPmZiRxljkOc5yrJEmqbQWqMoCuz7DtrhH9kRb9sWTdNA8fAo8cC6roKhdxhHh23bzruj4bIsPjZC2fsdzjlM0/StyVdjvKoqPD9d8BbGktv3PcZh+FWjxqmXA1kPkPnwNHoq+M/YVHVlhrtXSZCZagbPTN913fms8+meaGFeaTC3Vu5YR1CESlIti6jrGr1vxDkwOM+zqOKZd4Rz3nsiW5UwlxfU0Ss4Mi41SRIRoHSa4Hq9Ics/tp17z41z+9w6z9w6C6IoQpZlkmO8Zw7jnC9zZMtdU+Cmcxg7evmLKCOojAQcPp9F9uyzCYulmW/EUVlr5duwToVhiCAI5Nks+AtUQXaCo/kJEsRxLE3fASpbtvOQEMUwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test role here\"\n        title=\"test role here\"\n        src=\"/static/66b7f12a21b38ee627f03bab64549b77/fcda8/policysim-iam-policy2.png\"\n        srcset=\"/static/66b7f12a21b38ee627f03bab64549b77/12f09/policysim-iam-policy2.png 148w,\n/static/66b7f12a21b38ee627f03bab64549b77/e4a3f/policysim-iam-policy2.png 295w,\n/static/66b7f12a21b38ee627f03bab64549b77/fcda8/policysim-iam-policy2.png 590w,\n/static/66b7f12a21b38ee627f03bab64549b77/efc66/policysim-iam-policy2.png 885w,\n/static/66b7f12a21b38ee627f03bab64549b77/c83ae/policysim-iam-policy2.png 1180w,\n/static/66b7f12a21b38ee627f03bab64549b77/d777c/policysim-iam-policy2.png 1555w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This role gives my AWS resource, in this case my AWS Config Recorder, the following AWS Managed permissions:</p>\n<ul>\n<li>Read-Only access to AWS Services and resources</li>\n<li>A Default Policy for the AWS Config service so that AWS Config can track changes across my acount.</li>\n</ul>\n<p>The KMS Key is set up with the following permissions:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"key-consolepolicy-3\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Allow access for Key Administrators\",\n            *REDACTED*\n        },\n        {\n            \"Sid\": \"Allow Config to use this key\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Service\": \"config.amazonaws.com\"\n            },\n            \"Action\": \"kms:GenerateDataKey*\",\n            \"Resource\": \"*\",\n            \"Condition\": {\n                \"ArnLike\": {\n                    \"aws:SourceArn\": \"arn:aws:iam::**********:role/aws-controltower-ConfigRecorderRole\"\n                }\n            }\n        }\n    ]\n}</code></pre></div>\n<p>You can see that this key already has permissions to allow the above topic to run <code class=\"language-text\">KMS:GenerateDataKey*</code> using the key.</p>\n<p>Jumping back to the <code class=\"language-text\">aws-controltower-ConfigReecorderRole</code> on the AWS IAM Dashboard, you can see a button that says <strong>Simulate</strong>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7de992dfda60d6a28dc68d50fa29ccbd/e405b/policysim-iam-policy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVQY01VPuxKDMAzj/3+vQ5cOPbgrDSFA3jwCauQu7eCTLDuR3GRrkNwM5z1yztj3HTFGrOuKEIL013XhPE+pLy847IwSvWjHcUhx1phpxlspTNOElBK2bZNPuFBKEU5NdGLtg7Uw9xvs8wHvHMZxxDAMstMYY9C2LV59LyKLGg3IiSxVedd1ommtoWuIUf/v+nplw9P08EKrZsS8igs1Ip35gCmZvv8xpQHntqZdlkWQV30AE9cyeaEVrnwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Simualtor Button on IAM Role\"\n        title=\"Simualtor Button on IAM Role\"\n        src=\"/static/7de992dfda60d6a28dc68d50fa29ccbd/fcda8/policysim-iam-policy.png\"\n        srcset=\"/static/7de992dfda60d6a28dc68d50fa29ccbd/12f09/policysim-iam-policy.png 148w,\n/static/7de992dfda60d6a28dc68d50fa29ccbd/e4a3f/policysim-iam-policy.png 295w,\n/static/7de992dfda60d6a28dc68d50fa29ccbd/fcda8/policysim-iam-policy.png 590w,\n/static/7de992dfda60d6a28dc68d50fa29ccbd/efc66/policysim-iam-policy.png 885w,\n/static/7de992dfda60d6a28dc68d50fa29ccbd/c83ae/policysim-iam-policy.png 1180w,\n/static/7de992dfda60d6a28dc68d50fa29ccbd/e405b/policysim-iam-policy.png 1566w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If you click this, it will take you to the IAM Policy Simulator. Alternatively, you can jump into the Policy Simulator from the IAM Dashboard here.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d352effd2f7c9ff932c62669c0ae0c1/f470a/policysim-iam-dashboard.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.891891891891895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVQoz3VQy24TQRD0H3KOgsQpEbmAyGdwIxEHEiQev8CVCCk3EuVFbOWwMjHGstee3dn17O48dman6Bkb5wAZqTTdperu6u5lOcdo/BsF55hxiZcfbvHqUz9i//MALz72sXt0jZ1313h+fIO99zd49vYKW28usH14he2DSzw9vMST12f4cj5Fr6kq1HUNZQHnAXQGgjOIggGtJCKQj73uH6ZX5Aw8Y7DWRkKKCuksRbognqB4gdZ1MK2NsBS7zlPcYr7IMOgnWC7ryLmuQ6+umxhg7cUqRQMyLIWA1hramPiHgc45eP/gePRzgtNvF6RxK7+hoaDCsig2QkXFnPLgIAgC/jYKTUNu1kOSZISTr99x2x9iOmWrlfMsB2Ns07DRFsrYOFXq4KpDLnRcSWoaQrpa6rjPkuqSH3cYDhLMx1P4ztEN6UZlWW7WkFIiI2HbmjXj//s768DTOcqqgXctvFHwslk1LMoirhDEilwMZwITVpEzumfdIq9MRBYgDBiBU1ymM4zv7zH5NSK3C3it8AcIglp1C5Iz4gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IAM Dashboard\"\n        title=\"IAM Dashboard\"\n        src=\"/static/4d352effd2f7c9ff932c62669c0ae0c1/fcda8/policysim-iam-dashboard.png\"\n        srcset=\"/static/4d352effd2f7c9ff932c62669c0ae0c1/12f09/policysim-iam-dashboard.png 148w,\n/static/4d352effd2f7c9ff932c62669c0ae0c1/e4a3f/policysim-iam-dashboard.png 295w,\n/static/4d352effd2f7c9ff932c62669c0ae0c1/fcda8/policysim-iam-dashboard.png 590w,\n/static/4d352effd2f7c9ff932c62669c0ae0c1/efc66/policysim-iam-dashboard.png 885w,\n/static/4d352effd2f7c9ff932c62669c0ae0c1/c83ae/policysim-iam-dashboard.png 1180w,\n/static/4d352effd2f7c9ff932c62669c0ae0c1/f470a/policysim-iam-dashboard.png 1443w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once you are on the Policy Simulator Page, you can select</p>\n<ol>\n<li>The IAM User, Group or Role to use.</li>\n<li>The Service you need permission to.</li>\n<li>Specific Service actions you would like to use.</li>\n<li>Action settings -  you can provide resource ARN’s here.</li>\n<li>Run the Simulation</li>\n<li>View the Simulation results.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7adf31c59a21a08709be1442b5599eb9/d8c86/policysim-denied.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCklEQVQY032Qu04DMRBF9+dBFKHLJ1BQEBGgRAJFfAASSDSU7CbZlzf2vh07B9soCMJjpNFobM/xvRPlWcYyEzw8v3H3mPD0mrFerYiXFX0/kBcNm02FlAprbcjdbkfbtpRCYLaatdTcvgwoDVEcx6TrFXWtGIcBqRqSZEma5SilHEy63FBVVejruqZpGvdZH+picc/scs7Z+Zz51TWR1iM+xq0NtRA9cZIinaqyLCmKIgxLKRFOkQfmeU7btYhUMLu4YTI55eT4iOl0SuQfdF0XrBhj0No4S4Teh7f3V5itu/dixtGtoHOcnsjb8cA9xFrzY9BDf8uPsN/efQL3C/cq/4N8hR2e+dl3KXXKjOyG9kUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IAM Policy Simulator\"\n        title=\"IAM Policy Simulator\"\n        src=\"/static/7adf31c59a21a08709be1442b5599eb9/fcda8/policysim-denied.png\"\n        srcset=\"/static/7adf31c59a21a08709be1442b5599eb9/12f09/policysim-denied.png 148w,\n/static/7adf31c59a21a08709be1442b5599eb9/e4a3f/policysim-denied.png 295w,\n/static/7adf31c59a21a08709be1442b5599eb9/fcda8/policysim-denied.png 590w,\n/static/7adf31c59a21a08709be1442b5599eb9/efc66/policysim-denied.png 885w,\n/static/7adf31c59a21a08709be1442b5599eb9/c83ae/policysim-denied.png 1180w,\n/static/7adf31c59a21a08709be1442b5599eb9/d8c86/policysim-denied.png 1663w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>A simulaton has already been run in the above screenshot. You can see the <code class=\"language-text\">Access Denied</code> result with some additional information.</p>\n<p>Now I have enough information to create a custom IAM Policy I can attach to this role. I can also quickly test the custom policy on the role using the simulator.</p>\n<p>Here’s a result once the right policy has been attached.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/07a9c/policysim-success.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCUlEQVQY05WPwU7DMBBE8///wg9w4sQJqUJI0BZaqbR146SJ7cZOmjjJw7YoB04w0mhs7+54NjuXBat9xf3iwOO6ZrkrEcc9pzynaRr6vudyuaCUoq5rvPfM8/x9V2it2Bxr7p4KHt4qsvf3NeKwx18tTB7rWoQQ5MGwqiqcc8lQa51MrLWJ0Tzq1VmcddTaoZuOTFYabQxKG0wTml2XzOJApJQSE+qRt/eosixRuy3y9ZkmqPvc0u8+yLqQIGGeYBzxw5DWbNuWIZy7rksa1xxD/aYRYxsCnAVtKXFFjjeKTL0sMOGXfrvCb5b4QvAXROPfCJHITrkkF0d8SDX5ISTsfwb+y2ka+QJdh8zEkv76FAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Policy Simulator Passed\"\n        title=\"Policy Simulator Passed\"\n        src=\"/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/fcda8/policysim-success.png\"\n        srcset=\"/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/12f09/policysim-success.png 148w,\n/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/e4a3f/policysim-success.png 295w,\n/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/fcda8/policysim-success.png 590w,\n/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/efc66/policysim-success.png 885w,\n/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/c83ae/policysim-success.png 1180w,\n/static/fc40b6c00a0bc0cb049d29cbecb2ef6c/07a9c/policysim-success.png 1440w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>IAM Policy Simulator allows you to quickly debug and test IAM Policies attached to IAM Users, Groups or Roles against specific AWS resources. It saves time spent in manual testing by making this action one-click with instant results and is highly customizable.</p>\n<p>Big thanks to Martin Caarels, you can check out his blog <a href=\"https://blog.caarels.com\">here</a>.</p>","frontmatter":{"title":"Using AWS IAM Policy Simulator to debug IAM Policy Issues","date":"March 23, 2022","description":"Here's a handy tool you can use to debug your IAM Policies on AWS and ship Roles faster.","videoSrcURL":null,"videoTitle":null}}},"pageContext":{"slug":"/2022-03-23-aws-iam-policy-simulator/","previous":null,"next":{"fields":{"slug":"/2022-06-06-aws-twitch-stream/"},"frontmatter":{"title":"[VIDEO] Using AWS Migration Hub"}}}},"staticQueryHashes":["4123550546","63159454"]}